h1. Как использовать файлопровод (Asset Pipeline)

В прежних версиях Rails, все ресурсы были расположены в субдиректориях +public+, таких как +images+, +javascripts+ и +stylesheets+. Сейчас, с файлопроводом, предпочтительным местом размещения для этих ресурсов стала директория +app/assets+. Файлы в этой директории отдаются промежуточным ПО Sprockets, включенным в гем sprockets.

Это не означает, что ресурсы теперь не могут (или не должны) быть размещены в +public+; они все еще могут там быть и отданы как статичные файлы приложением или веб-сервером. Следует использовать +app/assets+, если хотите, чтобы ваши файлы прошли некоторую предварительную обработку перед тем, как начнут работать.

По умолчанию в production эти файлы прекомпилируются в +public/assets+, таким образом они могут быть более эффективно доставлены веб-сервером.

Когда для приложения генерируется скаффолд или контроллер, Rails также генерирует файл JavaScript (или файл CoffeeScript, если гем +coffee-rails+ имеется в +Gemfile+) и файл СSS (или файл SCSS, если +sass-rails+ имеется в +Gemfile+) для этого контроллера.

Например, если генерируется +ProjectsController+, будет новый файл +app/assets/javascripts/projects.js.coffee+ и еще один +app/assets/stylesheets/projects.css.scss+. Следует поместить любой JavaScript или CSS, уникальные для этого контроллера, в их соответствующие файлы ресурсов, таким образом эти файлы могут быть загружены только для этих контроллеров с помощью строк таких как +<%= javascript_include_tag params[:controller] %>+ или +<%= stylesheet_link_tag params[:controller] %>+.

NOTE: Вам необходим runtime, поддерживаемый "ExecJS":https://github.com/sstephenson/execjs#readme, чтобы использовать CoffeeScript. Если используете Mac OS X или Windows, у вас уже имеется JavaScript runtime, установленный в операционной системе. Обратитесь к документации по "ExecJS":https://github.com/sstephenson/execjs#readme, чтобы узнать обо всех поддерживаемых JavaScript runtime-ах.

h4. Организация ресурсов

Ресурсы могут быть размещены в приложении в одном из этих трех мест: +app/assets+, +lib/assets+ or +vendor/assets+.

+app/assets+ предназначено для ресурсов, принадлежащих приложению, таких как изображения, файлы JavaScript или таблицы стилей, изготовленные специально для приложения.

+lib/assets+ предназначено для кода ваших собственных библиотек, которые не вписываются в сферу применения приложения или эти библиотеки используются в нескольких приложениях.

+vendor/assets+ предназначено для ресурсов, принадлежащих сторонним субъектам, таких как код плагинов JavaScript.

Все субдиректории, существующие в пределах этих трех мест, добавляются в путь поиска для Sprockets (можно увидеть, вызвав +Rails.application.config.assets.paths+ в консоли). При запросе ресурса эти пути обходятся в поиске ресурса соответствующего указанному имени. Как только ресурс был найден, он обрабатывается Sprockets и отдается.

Можно добавить дополнительные (полные) пути к файлопроводу в +config/application.rb+. Например:

<ruby>
config.assets.paths << Rails.root.join("app", "assets", "flash")
</ruby>

h4. Кодирование ссылок на ресурсы

Sprockets не добавляет какие-либо новые методы для доступа к вашим ресурсам - используйте знакомые методы +javascript_include_tag+ и +stylesheet_link_tag+.

<erb>
<%= stylesheet_link_tag "application" %>
<%= javascript_include_tag "application" %>
</erb>

В обычных вьюхах можно получить доступ к изображениям в директории +assets/images+ следующим образом:

<erb>
<%= image_tag "rails.png" %>
</erb>

При условии, что файлопровод включен в вашем приложении (и не отключен в контексте текущей среды), этот файл будет отдан Sprockets'ом. Если файл существует в +public/assets/rails.png+, он будет отдан веб-сервером.

Кроме того, запрос файла с хешем MD5, такого как +public/assets/rails-af27b6a414e6da00003503148be9b409.png+ будет обработан тем же образом. Как генерируются эти хеши раскрыто в позже в этом руководстве в разделе "В production":/asset-pipeline/in-production.

Sprockets также будет смотреть в путях, определенных в +config.assets.paths+, включающие стандартные пути приложения и любой путь, добавленный движками (engine) Rails.

Изображения также могут быть организованы в субдиректории и могут быть доступны с помощью указания имени директории в теге:

<erb>
<%= image_tag "icons/rails.png" %>
</erb>

h5. CSS и ERB

Если добавить расширение +erb+ к ресурсу CSS, сделав его таким как +application.css.erb+, тогда будут доступны хелперы, такие как +asset_path+, в правилах вашего CSS:

<plain>
.class { background-image: url(<%= asset_path 'image.png' %>) }
</plain>

Это записывает путь к определенному указанному ресурсу. Этот пример имеет смысл если имеется изображение в одном из путей загрузки ресурсов, такое как +app/assets/images/image.png+, на которое тут будет ссылка. Если это изображение уже имеется в +public/assets+ как файл с меткой, то будет ссылка на него.

Если хотите использовать "data URI":http://ru.wikipedia.org/wiki/Data:_URL -- метод встравивания данных изображения непосредственно в файл CSS -- используйте хелпер +asset_data_uri+.

<plain>
#logo { background: url(<%= asset_data_uri 'logo.png' %>) }
</plain>

Это вставит правильно отформатированный URI в код CSS.

Отметьте, что закрывающий тег не может быть стиля +-%>+.

h5. CSS и Sass

При использовании файлопровода пути к ресурсам должны быть переписаны и +sass-rails+ представляет хелперы +-url+ и +-path+ helpers (через дефис в Sass, через подчеркивание в Ruby) для следующих типов ресурсов: изображение, шрифт, видео, аудио, JavaScript и таблица стилей.

* +image-url("rails.png")+ становится +url(/assets/rails.png)+
* +image-path("rails.png")+ становится +"/assets/rails.png"+.

Также может быть использована более общая форма, но должны быть указаны и путь к ресурсу, и его класс:

* +asset-url("rails.png", image)+ becomes +url(/assets/rails.png)+
* +asset-path("rails.png", image)+ becomes +"/assets/rails.png"+

h5. JavaScript/CoffeeScript и ERB

Если добавить расширение +erb+ к ресурсу JavaScript, сделав его чем-то вроде +application.js.erb+, можно использовать хелпер +asset_path+ в коде вашего JavaScript:

<erb>
$('#logo').attr({
  src: "<%= asset_path('logo.png') %>"
});
</erb>

Это записывает путь к определенному указанному ресурсу.

Подобным образом можно использовать хелпер +asset_path+ в файлах CoffeeScript с расширением +erb+ (т.е. +application.js.coffee.erb+):

<plain>
$('#logo').attr src: "<%= asset_path('logo.png') %>"
</plain>

h4. Файлы манифеста и директивы

Sprockets использует файлы манифеста для определения, какие ресурсы включать и отдавать. Эти файлы манифеста содержат _директивы_ -- инструкции, говорящие Sprockets, какие файлы требуются для создания отдельного файла CSS или JavaScript. С помощью этих директив Sprockets загружает указанные файлы, при необходимости их обрабатывает, соединяет в отдельный файл и затем сжимает их (если +Rails.application.config.assets.compress+ равно true). При отдаче одного файла, а не нескольких, время загрузки страницы значительно уменьшается, поскольку необходимо осуществить меньше запросов.

К примеру, в дефолтном приложении Rails имеется файл +app/assets/javascripts/application.js+, содержащий следующие строки:

<plain>
// ...
//= require jquery
//= require jquery_ujs
//= require_tree .
</plain>

В файлах JavaScript директивы начинаются с +//=+. В этом примере файл использует директивы +require+ и +require_tree+. Директива +require+ используется, чтобы указать Sprockets на требуемые файлы. Здесь затребованы файлы +jquery.js+ и +jquery_ujs.js+, которые доступны где-то по пути поиска для Sprockets. Не нужно явно указывать расширение. Sprockets предполагает, что вы требуете файл +.js+, когда выполняется из файла +.js+.

NOTE. В Rails 3.1 гем +jquery-rails+ предоставляет +jquery.js+ и +jquery_ujs.js+ через файлопровод. Вы не увидите их в директориях приложения.

Директива +require_tree+ говорит Sprockets рекурсивно включить _все_ файлы JavaScript в этой директории в результирующий файл. Может быть определен только путь относительно файла манифеста. Также есть директива +require_directory+, включающая все файлы JavaScript только в определенной директории (без вложенных директорий).

Директивы обрабатываются сверху вниз, но порядок, в котором файлы включаются с помощью +require_tree+ не определен. Не следует полагаться на какой-то определенный порядок при ее использовании. Если хотите убедиться, что какой-то определенный JavaScript закончится до некоторого другого, затребуйте его раньше в манифесте. Отметьте, что семейство директив +require+ предотвращает от повторного включения файлов в результирующий файл.

Также имеется дефолтный файл +app/assets/stylesheets/application.css+, содержащий эти строки:

<plain>
/* ...
*= require_self
*= require_tree .
*/
</plain>

Директивы, работающие в файлах JavaScript, также работают в таблицах стилей, явно включая таблицы стилей вместо JavaScript. Директива +require_tree+ работает так же, как и для JavaScript, включающая все таблицы стилей из текущей директории.

В этом примере использована +require_self+. Это помещает CSS, содержащийся в файле (если есть) в месте расположения вызова +require_self+. Если +require_self+ вызывается более одного раза, учитывается только последний вызов.

NOTE. Если хотите использовать несколько файлов Sass, используйте "правило Sass +@import+":http://sass-lang.com/docs/yardoc/file.SASS_REFERENCE.html#import вместо директив Sprockets. При использовании директив Sprockets все файлы существуют в своей собственной области видимости, что делает переменные или примеси (mixins) доступными только в документе, их определяющем.

Можно иметь сколько угодно манифестов. Для примера, манифесты +admin.css+ и +admin.js+ могут содержать файлы JS и CSS, используемые для административного раздела приложения.

Применяются те же оговорки о порядке следования, что сделаны выше. В частности, можно определить отдельные файлы и порядок, в котором они будут компилироваться:

<plain>
/* ...
*= require reset
*= require layout
*= require chrome
*/
</plain>

h4. Предварительная обработка

Расширение, использованное у ресурса, определяет, какая будет применена предварительная обработка. Когда генерируется скаффолд или контроллер с помощью дефолтного набора гемов Rails, создадутся файл CoffeeScript и файл SCSS вместо обычных файлов JavaScript и CSS. В использованном ранее примере был контроллер с именем "projects", который создал файлы +app/assets/javascripts/projects.js.coffee+ и +app/assets/stylesheets/projects.css.scss+.

Когда запрашиваются эти файлы, они обрабатываются процессорами, представленными гемами +coffee-script+ и +sass-rails+, а затем отдаются браузеру как JavaScript и CSS соответственно.

Может быть запрошен дополнительный уровень обработки, если добавить другое расширение, каждое расширение обрабатывается в порядке справа налево. Их следует использовать в том порядке, в котором должна быть применена обработка. Например, таблица стилей с именем +app/assets/stylesheets/projects.css.scss.erb+ сначала обрабатывается как ERB, затем SCSS и, наконец, отдается как CSS. То же самое применимо к файлу JavaScript -- +app/assets/javascripts/projects.js.coffee.erb+ обрабатывается как ERB, CoffeeScript и отдается как JavaScript.

Помните, что порядок этих препроцессоров важен. Например, если вызовите свой файл JavaScript +app/assets/javascripts/projects.js.erb.coffee+, то он будет сначала обработан интерпретатором CoffeeScript, который не понимает ERB, и, следовательно, возникнут проблемы.
